
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============== Helper Functions ==============
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      // This assumes you have a custom claim 'isAdmin' set to true for admin users.
      return isAuthenticated() && request.auth.token.isAdmin == true;
    }

    function isTeacherProfileUpdateValid(requestData, resourceData) {
      let allowedChanges = requestData.fullName is string && requestData.fullName.size() > 0
                           && requestData.subjectsTaught is string
                           && requestData.contactNumber is string
                           && requestData.assignedClasses is list;
      let immutableFieldsProtected = requestData.email == resourceData.email
                                  && requestData.uid == resourceData.uid
                                  && (!requestData.keys().has('role') || requestData.role == resourceData.role);
      return allowedChanges && immutableFieldsProtected;
    }

    function isTimetableDocIdValid(docId, userId) {
      return docId.size() > userId.size() + 1 && docId.matches(userId + '_[A-Za-z]+');
    }

    function isTimetableDataValid(data, userId) {
      let periodsStructureIsValid = data.periods is list &&
                                    (data.periods.size() == 0 ||
                                      (data.periods.size() > 0 &&
                                        data.periods[0].keys().has('startTime') &&
                                        data.periods[0].keys().has('endTime') &&
                                        data.periods[0].keys().has('subjects') &&
                                        data.periods[0].keys().has('classNames') &&
                                        data.periods[0].startTime is string && data.periods[0].startTime.matches('^[0-2][0-9]:[0-5][0-9]$') &&
                                        data.periods[0].endTime is string && data.periods[0].endTime.matches('^[0-2][0-9]:[0-5][0-9]$') &&
                                        (data.periods[0].startTime < data.periods[0].endTime || data.periods[0].startTime == data.periods[0].endTime) &&
                                        data.periods[0].subjects is list && (data.periods[0].subjects.size() == 0 || data.periods[0].subjects[0] is string) &&
                                        data.periods[0].classNames is list && (data.periods[0].classNames.size() == 0 || data.periods[0].classNames[0] is string)
                                      )
                                    );
      return data.keys().has('teacherId') && data.keys().has('dayOfWeek') && data.keys().has('periods') && data.keys().has('updatedAt')
             && data.teacherId == userId
             && data.dayOfWeek is string
             && periodsStructureIsValid;
    }

    // ============== App Settings ==============
    match /appSettings/general {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ============== Students ==============
    match /students/{studentId} {
      // Allows student login to check existence of a specific ID (get operation)
      allow get: if true;

      // Admins can list any students.
      // Authenticated teachers can list students (client queries MUST filter by gradeLevel).
      allow list: if isAuthenticated(); 

      // Admins can get any student.
      // Authenticated teachers can get a student if that student is in one of their assigned classes.
      allow get: if isAdmin() ||
                   (isAuthenticated() && request.auth.uid != null &&
                    exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) && // Ensure teacher profile exists
                    resource.data.gradeLevel in get(/databases/$(database)/documents/teachers/$(request.auth.uid)).data.assignedClasses);
      
      // Write operations only for Admins
      allow create, update, delete: if isAdmin();
    }

    // ============== Teachers ==============
    match /teachers/{teacherId} {
      // Admin has full read/write access.
      allow read, write: if isAdmin();

      // Teacher can read their own profile.
      // The !isAdmin() ensures this rule doesn't conflict if an admin is also a teacher.
      allow read: if isAuthenticated() && request.auth.uid == teacherId && !isAdmin();

      // Teacher can update their own profile with validation.
      allow update: if isAuthenticated() && request.auth.uid == teacherId
                      && isTeacherProfileUpdateValid(request.resource.data, resource.data)
                      && !isAdmin();

      // Only admins can delete teacher profiles.
      allow delete: if isAdmin();
    }

    // ============== Payments ==============
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ============== Assignments ==============
    match /assignments/{assignmentId} {
      function isAssignmentOwner() {
        return resource.data.teacherId == request.auth.uid;
      }
      function isAssignmentDataValidForCreate() {
        return request.resource.data.keys().has('teacherId') && request.resource.data.keys().has('teacherName') &&
               request.resource.data.keys().has('classId') && request.resource.data.keys().has('title') &&
               request.resource.data.keys().has('description') && request.resource.data.keys().has('dueDate') &&
               request.resource.data.keys().has('createdAt')
               && request.resource.data.teacherId == request.auth.uid
               && request.resource.data.teacherName is string
               && request.resource.data.classId is string && request.resource.data.classId.size() > 0
               && request.resource.data.title is string && request.resource.data.title.size() > 0
               && request.resource.data.description is string && request.resource.data.description.size() > 0
               && request.resource.data.dueDate is timestamp
               && request.resource.data.createdAt == request.time;
      }
      function isAssignmentDataValidForUpdate() {
        let commonFieldsValid = request.resource.data.keys().has('classId') && request.resource.data.keys().has('title') &&
                                request.resource.data.keys().has('description') && request.resource.data.keys().has('dueDate')
               && request.resource.data.classId is string && request.resource.data.classId.size() > 0
               && request.resource.data.title is string && request.resource.data.title.size() > 0
               && request.resource.data.description is string && request.resource.data.description.size() > 0
               && request.resource.data.dueDate is timestamp;
        let immutableFieldsProtected = request.resource.data.teacherId == resource.data.teacherId
               && request.resource.data.teacherName == resource.data.teacherName
               && request.resource.data.createdAt == resource.data.createdAt;
        return commonFieldsValid && immutableFieldsProtected;
      }

      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isAssignmentDataValidForCreate();
      allow update: if isAuthenticated() && isAssignmentOwner() && isAssignmentDataValidForUpdate();
      allow delete: if isAuthenticated() && isAssignmentOwner();
    }

    // ============== Attendance Entries ==============
    match /attendanceEntries/{entryId} {
      function isAttendanceOwner() {
        return resource.data.markedByTeacherId == request.auth.uid;
      }
      function isAttendanceDataValidForCreate() {
        return request.resource.data.keys().has('studentId') && request.resource.data.keys().has('studentName') &&
               request.resource.data.keys().has('className') && request.resource.data.keys().has('date') &&
               request.resource.data.keys().has('status') && request.resource.data.keys().has('notes') &&
               request.resource.data.keys().has('markedByTeacherId') && request.resource.data.keys().has('markedByTeacherName') &&
               request.resource.data.keys().has('lastUpdatedAt')
               && request.resource.data.studentId is string
               && request.resource.data.studentName is string
               && request.resource.data.className is string
               && request.resource.data.date is timestamp
               && request.resource.data.status in ['present', 'absent', 'late']
               && request.resource.data.notes is string
               && request.resource.data.markedByTeacherId == request.auth.uid
               && request.resource.data.markedByTeacherName is string
               && request.resource.data.lastUpdatedAt == request.time;
      }
      function isAttendanceDataValidForUpdate() {
        let updatableFieldsValid = request.resource.data.keys().has('status') && request.resource.data.keys().has('notes') &&
                                   request.resource.data.keys().has('lastUpdatedAt')
               && request.resource.data.status in ['present', 'absent', 'late']
               && request.resource.data.notes is string
               && request.resource.data.lastUpdatedAt == request.time;
        let immutableFieldsProtected = request.resource.data.studentId == resource.data.studentId
               && request.resource.data.studentName == resource.data.studentName
               && request.resource.data.className == resource.data.className
               && request.resource.data.date == resource.data.date
               && request.resource.data.markedByTeacherId == resource.data.markedByTeacherId
               && request.resource.data.markedByTeacherName == resource.data.markedByTeacherName;
        return updatableFieldsValid && immutableFieldsProtected;
      }

      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isAttendanceDataValidForCreate();
      allow update: if isAuthenticated() && isAttendanceOwner() && isAttendanceDataValidForUpdate();
      allow delete: if isAuthenticated() && isAttendanceOwner();
    }

    // ============== Timetable Entries ==============
    match /timetableEntries/{entryId} {
      function isTimetableEntryOwner(entryData) {
        return entryData.keys().has('teacherId') &&
               entryData.teacherId is string &&
               entryData.teacherId == request.auth.uid;
      }

      allow read: if isAuthenticated() && isTimetableEntryOwner(resource.data);
      allow create: if isAuthenticated()
                      && isTimetableDataValid(request.resource.data, request.auth.uid)
                      && request.resource.data.createdAt == request.time
                      && request.resource.data.updatedAt == request.time
                      && isTimetableDocIdValid(entryId, request.auth.uid);
      allow update: if isAuthenticated()
                      && isTimetableEntryOwner(resource.data)
                      && isTimetableDataValid(request.resource.data, request.auth.uid)
                      && request.resource.data.teacherId == resource.data.teacherId
                      && request.resource.data.dayOfWeek == resource.data.dayOfWeek
                      && request.resource.data.createdAt == resource.data.createdAt
                      && request.resource.data.updatedAt == request.time
                      && isTimetableDocIdValid(entryId, request.auth.uid);
      allow delete: if isAuthenticated()
                      && isTimetableEntryOwner(resource.data)
                      && isTimetableDocIdValid(entryId, request.auth.uid);
    }
  }
}

    