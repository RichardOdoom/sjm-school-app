
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    // !!! CRITICAL FOR PRODUCTION !!!
    // The current isAdmin() function is for DEVELOPMENT ONLY.
    // For PRODUCTION, use Firebase Auth custom claims:
    // function isAdmin() {
    //   return isAuthenticated() && request.auth.token.admin == true;
    // }
    function isAdmin() {
      // DEVELOPMENT ONLY: Allows any logged-in user to act as admin.
      return isAuthenticated();
    }

    // Helper to check if the requesting user is a teacher.
    function isTeacher() {
      return isAuthenticated() && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    // Helper to get teacher's data.
    function getTeacherData() {
      // Ensure teacher data exists before trying to access fields to prevent errors in rules
      let teacherDoc = get(/databases/$(database)/documents/teachers/$(request.auth.uid));
      if (!teacherDoc.data.keys().hasAll(['assignedClasses'])) {
        return null; // Or a default map that won't cause errors
      }
      return teacherDoc.data;
    }

    // Helper to check if a list field exists and is a list
    function isListAndNotEmpty(list) {
      return list != null && list is list && list.size() > 0;
    }

    // --- Teachers Collection ---
    match /teachers/{teacherId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == teacherId);
      allow create: if isAdmin(); // Admin registers teachers
      allow update: if isAdmin() || (isAuthenticated() && request.auth.uid == teacherId); // Teacher updates own, admin updates any
      allow delete: if isAdmin();
    }

    // --- Students Collection ---
    // studentDocId here is the 10-digit application ID, which is the document ID.
    match /students/{studentDocId} {
      allow create: if isAdmin(); // Admin registers students

      // Read access:
      // 1. Public GET access for individual student document for login ID verification.
      //    This is broad for verification. Ideally, a backend function would handle this.
      //    For listing/querying students, specific authenticated roles are required below.
      // 2. Admins can list/query any students.
      // 3. Teachers can list/query students in their assigned classes.
      // Note: Firestore rules are not filters. `list` operations require broader permissions
      // than `get` operations for individual documents.
      allow get: if true; // Allows StudentLoginForm to check if student ID exists.
      allow list: if isAdmin() || isTeacher(); // Teachers can list (e.g., for their dashboard), admins can list.
                                          // Teachers will filter client-side or via specific queries.

      // Update/Delete: Only by admins.
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- Fee Payments Collection ---
    match /payments/{paymentId} {
      allow create, read, update, delete: if isAdmin();
    }

    // --- Application Settings ---
    match /appSettings/{settingsDocId} {
      match /general {
        allow read: if true; // Publicly readable (school name, logo URL for homepage, etc.)
        allow write: if isAdmin();
      }
      // For any OTHER documents in appSettings (if you add more later)
      allow read, write: if isAdmin() && settingsDocId != 'general';
    }

    // --- Attendance Entries Collection ---
    // entryDocId is typically studentId_YYYY-MM-DD
    // resource.data.studentId refers to the 10-digit application-specific student ID.
    match /attendanceEntries/{entryDocId} {
      // Read access:
      // 1. Admins can read any attendance.
      // 2. Students can read their own attendance records (this relies on client-side fetching studentId from localStorage)
      //    Since student login is mock, we can't directly use request.auth.uid here for students.
      //    The client app will fetch using the studentId from localStorage.
      //    This rule allows any authenticated user to read, client must filter.
      //    Or, rely on isAdmin for now.
      // 3. Teachers can read attendance for students in classes they are assigned to.
      allow read: if isAdmin() ||
                    isTeacher() || // Teachers can read broadly, then filter client-side or via queries
                    isAuthenticated(); // Students (any authenticated user after mock login) can read.

      // Create/Update access:
      // Only teachers can create/update attendance, and only for their assigned classes,
      // and they must mark themselves as the one who marked it.
      allow create, update: if isTeacher() &&
                               request.auth.uid == request.resource.data.markedByTeacherId &&
                               getTeacherData() != null && // Ensure teacher data loaded
                               isListAndNotEmpty(getTeacherData().assignedClasses) &&
                               getTeacherData().assignedClasses.hasAny([request.resource.data.className]);

      // Delete access: Only by admins for now.
      allow delete: if isAdmin();
    }

    // --- Default Deny (IMPORTANT FOR PRODUCTION) ---
    // Uncomment this block once all necessary paths have explicit allow rules.
    // For active development, you might keep it commented out.
    /*
    match /{document=**} {
      allow read, write: if false;
    }
    */
  }
}

    